# æ·±å…¥ç†è§£ python è™šæ‹Ÿæœºï¼šGIL æºç åˆ†æâ€”â€”å¤©ä½¿è¿˜æ˜¯é­”é¬¼ï¼Ÿ

åœ¨ç›®å‰çš„ CPython å½“ä¸­ä¸€ç›´æœ‰ä¸€ä¸ªè‡­åæ˜­è‘—çš„é—®é¢˜å°±æ˜¯ GIL (Global Interpreter Lock )ï¼Œå°±æ˜¯å…¨å±€è§£é‡Šå™¨é”ï¼Œä»–é™åˆ¶äº† Python åœ¨å¤šæ ¸æ¶æ„å½“ä¸­çš„æ€§èƒ½ï¼Œåœ¨æœ¬ç¯‡æ–‡ç« å½“ä¸­æˆ‘ä»¬å°†è¯¦ç»†åˆ†æä¸€ä¸‹ GIL çš„åˆ©å¼Šå’Œ GIL å®ç°çš„ C çš„æºä»£ç ã€‚



## é€‰æ‹© GIL çš„åŸå› 

### GIL å¯¹ Python ä»£ç çš„å½±å“

ç®€å•æ¥è¯´ï¼ŒPython å…¨å±€è§£é‡Šå™¨é”æˆ– GIL æ˜¯ä¸€ä¸ªäº’æ–¥é”ï¼Œåªå…è®¸ä¸€ä¸ªçº¿ç¨‹ä¿æŒ Python è§£é‡Šå™¨çš„æ§åˆ¶æƒï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨åŒä¸€ä¸ªæ—¶åˆ»åªèƒ½å¤Ÿæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ Python ä»£ç ï¼Œå¦‚æœæ•´ä¸ªç¨‹åºæ˜¯å•çº¿ç¨‹çš„è¿™ä¹Ÿæ— ä¼¤å¤§é›…ï¼Œä½†æ˜¯å¦‚æœä½ çš„ç¨‹åºæ˜¯å¤šçº¿ç¨‹è®¡ç®—å¯†é›†å‹çš„ç¨‹åºçš„è¯ï¼Œè¿™å¯¹ç¨‹åºçš„å½±å“å°±å¾ˆå¤§äº†ã€‚

å› ä¸ºæ•´ä¸ªè™šæ‹Ÿæœºéƒ½æœ‰ä¸€æŠŠå¤§é”è¿›è¡Œä¿æŠ¤ï¼Œæ‰€ä»¥è™šæ‹Ÿçš„ä»£ç å°±å¯ä»¥è®¤ä¸ºæ˜¯å•çº¿ç¨‹æ‰§è¡Œçš„ï¼Œå› æ­¤ä¸éœ€è¦åšçº¿ç¨‹å®‰å…¨çš„é˜²æŠ¤ï¼Œç›´æ¥æŒ‰ç…§å•çº¿ç¨‹çš„é€»è¾‘å°±è¡Œäº†ã€‚ä¸ä»…ä»…æ˜¯è™šæ‹Ÿæœºï¼ŒPython å±‚é¢çš„ä»£ç ä¹Ÿæ˜¯è¿™æ ·ï¼Œå¯¹äº Python å±‚é¢çš„å¤šçº¿ç¨‹ä»£ç ä¹Ÿå¯ä»¥ä¸ç”¨é”ä¿æŠ¤ï¼Œå› ä¸ºæœ¬èº«å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼š

```python
import threading

data = []


def add_data(n):
	for i in range(n):
		data.append(i)


if __name__ == '__main__':
	ts = [threading.Thread(target=add_data, args=(10,)) for _ in range(10)]
	for t in ts:
		t.start()
	for t in ts:
		t.join()

	print(data)
	print(len(data))
	print(sum(data))
```

åœ¨ä¸Šé¢çš„ä»£ç å½“ä¸­ï¼Œå½“ç¨‹åºæ‰§è¡Œå®Œä¹‹å `len(data)` çš„å€¼æ°¸è¿œéƒ½æ˜¯ 100ï¼Œ`sum(data) ` çš„å€¼æ°¸è¿œéƒ½æ˜¯ 450ï¼Œå› ä¸ºä¸Šé¢çš„ä»£ç æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯èƒ½ä½ ä¼šæœ‰æ‰€ç–‘æƒ‘ï¼Œä¸Šé¢çš„ä»£ç å¯åŠ¨äº† 10 ä¸ªçº¿ç¨‹åŒæ—¶å¾€åˆ—è¡¨å½“ä¸­å¢åŠ æ•°æ®ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å¢åŠ æ•°æ®çš„æ—¶å€™å°±æœ‰å¯èƒ½å­˜åœ¨çº¿ç¨‹ä¹‹é—´è¦†ç›–çš„æƒ…å†µï¼Œæœ€ç»ˆçš„ `len(data)` çš„é•¿åº¦åº”è¯¥å°äº 100 ï¼Ÿ

ä¸Šé¢çš„ä»£ç ä¹‹æ‰€ä»¥æ˜¯çº¿ç¨‹å®‰å…¨çš„åŸå› æ˜¯å› ä¸º `data.append(i)` æ‰§è¡Œ append åªéœ€è¦è™šæ‹Ÿæœºçš„ä¸€æ¡å­—èŠ‚ç ï¼Œè€Œåœ¨å‰é¢ä»‹ç» GIL æ—¶å€™å·²ç»è°ˆåˆ°äº†ï¼Œæ¯ä¸ªæ—¶åˆ»åªèƒ½å¤Ÿæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œè™šæ‹Ÿæœºçš„å­—èŠ‚ç ï¼Œè¿™å°±ä¿è¯äº†æ¯ä¸ª append çš„æ“ä½œéƒ½æ˜¯åŸå­çš„ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ª append æ“ä½œæ‰§è¡Œå®Œæˆä¹‹åå…¶ä»–çš„çº¿ç¨‹æ‰èƒ½å¤Ÿæ‰§è¡Œ append æ“ä½œã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä¸Šé¢ç¨‹åºçš„å­—èŠ‚ç ï¼š

```python
  5           0 LOAD_GLOBAL              0 (range)
              2 LOAD_FAST                0 (n)
              4 CALL_FUNCTION            1
              6 GET_ITER
        >>    8 FOR_ITER                14 (to 24)
             10 STORE_FAST               1 (i)

  6          12 LOAD_GLOBAL              1 (data)
             14 LOAD_METHOD              2 (append)
             16 LOAD_FAST                1 (i)
             18 CALL_METHOD              1
             20 POP_TOP
             22 JUMP_ABSOLUTE            8
        >>   24 LOAD_CONST               0 (None)
             26 RETURN_VALUE
```

åœ¨ä¸Šé¢çš„å­—èŠ‚ç å½“ä¸­ `data.append(i)` å¯¹åº”çš„å­—èŠ‚ç ä¸º (14, 16, 18) è¿™ä¸‰æ¡å­—èŠ‚ç ï¼Œè€Œ (14, 16) æ˜¯ä¸ä¼šäº§ç”Ÿæ•°æ®ç«äº‰çš„é—®é¢˜çš„ï¼Œå› ä¸ºä»–åªæ˜¯åŠ è½½å¯¹è±¡çš„æ–¹æ³•å’Œå±€éƒ¨å˜é‡ `i` çš„å€¼ï¼Œè®© append æ‰§è¡Œçš„æ–¹æ³•æ˜¯å­—èŠ‚ç  CALL_METHODï¼Œè€ŒåŒä¸€ä¸ªæ—¶åˆ»åªèƒ½å¤Ÿæœ‰ä¸€ä¸ªå­—èŠ‚ç åœ¨æ‰§è¡Œï¼Œå› æ­¤è¿™æ¡å­—èŠ‚ç ä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥æ‰ä¼šæœ‰ä¸Šé¢çš„ä»£ç æ˜¯çº¿ç¨‹å®‰å…¨çš„æƒ…å†µå‡ºç°ã€‚

æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸ªéçº¿ç¨‹å®‰å…¨çš„ä¾‹å­ï¼š

```python
import threading
data = 0
def add_data(n):
	global data
	for i in range(n):
		data += 1

if __name__ == '__main__':
	ts = [threading.Thread(target=add_data, args=(100000,)) for _ in range(20)]
	for t in ts:
		t.start()
	for t in ts:
		t.join()
	print(data)
```

åœ¨ä¸Šé¢çš„ä»£ç å½“ä¸­å¯¹äº data += 1 è¿™ä¸ªæ“ä½œå°±æ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸ºè¿™è¡Œä»£ç æ±‡ç¼–ç¼–è¯‘æˆ 3 æ¡å­—èŠ‚ç ï¼š

```bash
  9          12 LOAD_GLOBAL              1 (data)
             14 LOAD_CONST               1 (1)
             16 INPLACE_ADD
```

é¦–å…ˆ LOAD_GLOBALï¼ŒåŠ è½½ data æ•°æ®ï¼ŒLOAD_CONST åŠ è½½å¸¸é‡ 1ï¼Œæœ€åæ‰§è¡Œ INPLACE_ADD è¿›è¡ŒåŠ æ³•æ“ä½œï¼Œè¿™å°±å¯èƒ½å‡ºç°çº¿ç¨‹1æ‰§è¡Œå®Œ LOAD_GLOBAL ä¹‹åï¼Œçº¿ç¨‹ 2 è¿ç»­æ‰§è¡Œ 3 æ¡å­—èŠ‚ç ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ data çš„å€¼å·²ç»å‘ç”Ÿå˜åŒ–äº†ï¼Œè€Œçº¿ç¨‹ 1 æ‹¿çš„è¿˜æ˜¯æ—§çš„æ•°æ®ï¼Œå› æ­¤æœ€ç»ˆæ‰§è¡Œçš„ä¹‹åä¼šå‡ºç°çº¿ç¨‹ä¸å®‰å…¨çš„æƒ…å†µã€‚ï¼ˆå®é™…ä¸Šè™šæ‹Ÿæœºåœ¨æ‰§è¡Œçš„è¿‡ç¨‹å½“ä¸­ï¼Œå‘ç”Ÿæ•°æ®ç«äº‰æ¯”è¿™ä¸ªå¤æ‚å¾ˆå¤šï¼Œè¿™é‡Œåªæ˜¯ç®€å•è¯´æ˜ä¸€ä¸‹ï¼‰

### GIL å¯¹äºè™šæ‹Ÿæœºçš„å½±å“

é™¤äº†ä¸Šé¢ GIL å¯¹äº Python ä»£ç å±‚é¢çš„å½±å“ï¼ŒGIL å¯¹äºè™šæ‹Ÿæœºæ¥è¯´è¿˜æœ‰ä¸€ä¸ªéå¸¸å¥½çš„ä½œç”¨å°±æ˜¯ä»–ä¸ä¼šè®©è™šæ‹Ÿæœºäº§ç”Ÿæ­»é”çš„ç°è±¡ï¼Œå› ä¸ºæ•´ä¸ªè™šæ‹Ÿæœºåªæœ‰ä¸€æŠŠé”ğŸ”’ã€‚

GIL æœ€å¤§çš„å½±å“æ˜¯å¯¹äºè™šæ‹Ÿæœºï¼Œå¯¹äºè™šæ‹Ÿæœºçš„å†…å­˜ç®¡ç†å’Œåƒåœ¾å›æ”¶æ¥è¯´ï¼ŒGIL å¯ä»¥è¯´æå¤§çš„ç®€åŒ–äº† CPython å†…éƒ¨çš„å†…å­˜ç®¡ç†å’Œåƒåœ¾å›æ”¶çš„å®ç°ã€‚æˆ‘ä»¬ç°åœ¨ä¸¾ä¸€ä¸ªå†…å­˜ç®¡ç†å’Œåƒåœ¾å›æ”¶çš„å¤šçº¿ç¨‹æƒ…å†µä¼šå‡ºç°æ•°æ®ç«äº‰çš„åœºæ™¯ï¼š

åœ¨ Python å½“ä¸­çš„åƒåœ¾å›æ”¶æ˜¯é‡‡ç”¨å¼•ç”¨è®¡æ•°çš„æ–¹å¼è¿›è¡Œå¤„ç†ï¼Œå¦‚æœæ²¡æœ‰ GIL é‚£ä¹ˆå°±ä¼šå­˜åœ¨å¤šä¸ªçº¿ç¨‹åŒæ—¶å¯¹ä¸€ä¸ª CPython å¯¹è±¡çš„å¼•ç”¨è®¡æ•°è¿›è¡Œå¢åŠ ï¼Œè€Œç°åœ¨å› ä¸º GIL çš„å­˜åœ¨ä¹Ÿå°±ä¸éœ€è¦è¿›è¡Œè€ƒè™‘è¿™ä¸ªé—®é¢˜äº†ã€‚

å¦å¤–ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„åœºæ™¯å°±æ˜¯å†…å­˜çš„ç”³è¯·å’Œé‡Šæ”¾ï¼šåœ¨è™šæ‹Ÿæœºå†…éƒ¨å¹¶ä¸æ˜¯ç›´æ¥è°ƒç”¨ malloc è¿›è¡Œå®ç°çš„ï¼Œåœ¨ CPython å†…éƒ¨è‡ªå·±å®ç°äº†ä¸€ä¸ªå†…å­˜æ± è¿›è¡Œå†…å­˜çš„ç”³è¯·å’Œé‡Šæ”¾ï¼ˆè¿™ä¹ˆåšçš„åŸå› ä¸»è¦æ˜¯èŠ‚çœå†…å­˜ï¼‰ï¼Œå› ä¸ºæ˜¯è‡ªå·±å®ç°å†…å­˜æ± ï¼Œå› æ­¤éœ€è¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œè€Œç°åœ¨å› ä¸ºæœ‰ GIL çš„å­˜åœ¨ï¼Œè™šæ‹Ÿæœºå®ç°å†…å­˜æ± åªéœ€è¦ç®¡å•çº¿ç¨‹çš„æƒ…å†µï¼Œæ‰€ä»¥ä½¿å¾—æ•´ä¸ªå†…å­˜ç®¡ç†å˜å¾—æ›´åŠ ç®€å•ã€‚

GIL å¯¹ä¸ Python çš„ç¬¬ä¸‰æ–¹ C åº“å¼€å‘äººå‘˜æ¥è¯´ä¹Ÿæ˜¯éå¸¸å‹å¥½çš„ï¼Œå½“ä»–ä»¬åœ¨è¿›è¡Œç¬¬ä¸‰æ–¹åº“å¼€å‘çš„æ—¶å€™ä¸éœ€è¦å»è€ƒè™‘åœ¨ä¿®æ”¹ CPython å¯¹è±¡çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå› ä¸ºå·²ç»æœ‰ GIL äº†ã€‚ä»è¿™ä¸ªè§’åº¦æ¥è¯´ GIL åœ¨ä¸€å®šç¨‹åº¦ä¸Šæ¨åŠ¨äº† Python çš„å‘å±•å’Œæ™®åŠã€‚

## GIL å¸¦æ¥çš„é—®é¢˜

GIL å¸¦æ¥çš„æœ€ä¸»è¦çš„é—®é¢˜å°±æ˜¯å½“ä½ çš„ç¨‹åºæ˜¯è®¡ç®—å¯†é›†å‹çš„æ—¶å€™ï¼Œæ¯”å¦‚æ•°å­¦è®¡ç®—ã€å›¾åƒå¤„ç†ï¼ŒGIL å°±ä¼šå¸¦æ¥æ€§èƒ½é—®é¢˜ï¼Œå› ä¸ºä»–æ— æ³•åœ¨åŒä¸€ä¸ªæ—¶åˆ»è·‘å¤šä¸ªçº¿ç¨‹ã€‚

ä¹‹æ‰€ä»¥æ²¡æœ‰åœ¨ Python å½“ä¸­åˆ é™¤ GILï¼Œæœ€ä¸»è¦çš„åŸå› å°±æ˜¯ç›®å‰å¾ˆå¤š CPython ç¬¬ä¸‰æ–¹åº“æ˜¯ä¾èµ– GIL è¿™ä¸ªç‰¹æ€§çš„ï¼Œå¦‚æœç›´æ¥åœ¨è™šæ‹Ÿæœºå±‚é¢ç§»é™¤ GILï¼Œå°±ä¼šç ´å CPython C-API çš„å…¼å®¹æ€§ï¼Œè¿™ä¼šå¯¼è‡´å¾ˆå¤šä¾èµ– GIL çš„ç¬¬ä¸‰æ–¹ C åº“å‘ç”Ÿé”™è¯¯ã€‚è€Œå‘åå…¼å®¹è¿™ä¸ªç‰¹æ€§å¯¹äºç¤¾åŒºæ¥è¯´éå¸¸é‡è¦ï¼Œè¿™å°±æ˜¯ç›®å‰ CPython è¿˜ä¿ç•™ GIL æœ€ä¸»è¦çš„åŸå› ã€‚

## GIL æºä»£ç åˆ†æ

åœ¨æœ¬å°èŠ‚å½“ä¸­ä¸ºäº†æ›´å¥½çš„è¯´æ˜ GIL çš„è®¾è®¡å’Œæºä»£ç åˆ†æï¼Œæœ¬å°èŠ‚ä½¿ç”¨ CPython2.7.6 çš„ GIL æºä»£ç è¿›è¡Œåˆ†æï¼Œæˆ‘è¿˜ç¿»äº†ä¸€ä¸‹æ›´æ—©çš„ CPython æºä»£ç ï¼Œéƒ½æ˜¯ä½¿ç”¨è¿™ç§æ–¹å¼å®ç°çš„ï¼ˆè¿™ç§å®ç°æ–¹å¼åœ¨ Python 3.2 ä»¥åè¢«ä¼˜åŒ–æ”¹è¿›äº†ï¼Œåœ¨æœ¬æ–‡å½“ä¸­å…ˆä¸æåŠï¼‰ï¼Œæˆ‘ä»¬ç°åœ¨æ¥åˆ†æä¸€ä¸‹ GIL å…·ä½“æ˜¯å¦‚ä½•å®ç°çš„ï¼š

```c
void 
PyThread_release_lock(PyThread_type_lock lock)
{
	pthread_lock *thelock = (pthread_lock *)lock;
	int status, error = 0;
  // dprintf éƒ½æ˜¯æ‰“å°æ¶ˆæ¯çš„ï¼Œä¸éœ€è¦å…³å¿ƒ
	dprintf(("PyThread_release_lock(%p) called\n", lock));

	status = pthread_mutex_lock( &thelock->mut );
	CHECK_STATUS("pthread_mutex_lock[3]");

	thelock->locked = 0;

	status = pthread_mutex_unlock( &thelock->mut );
	CHECK_STATUS("pthread_mutex_unlock[3]");

	/* wake up someone (anyone, if any) waiting on the lock */
	status = pthread_cond_signal( &thelock->lock_released );
	CHECK_STATUS("pthread_cond_signal");
}

void 
PyThread_release_lock(PyThread_type_lock lock)
{
	pthread_lock *thelock = (pthread_lock *)lock;
	int status, error = 0;

	dprintf(("PyThread_release_lock(%p) called\n", lock));

	status = pthread_mutex_lock( &thelock->mut );
	CHECK_STATUS("pthread_mutex_lock[3]");

	thelock->locked = 0;

	status = pthread_mutex_unlock( &thelock->mut );
	CHECK_STATUS("pthread_mutex_unlock[3]");

	/* wake up someone (anyone, if any) waiting on the lock */
	status = pthread_cond_signal( &thelock->lock_released );
	CHECK_STATUS("pthread_cond_signal");
}
```

pthread_lock çš„ç»“æ„ä½“å¦‚ä¸‹æ‰€ç¤ºï¼š

å…¶ä¸­é”çš„ç»“æ„ä½“å¦‚ä¸‹æ‰€ç¤ºï¼š

```c
typedef struct {
	char             locked; /* 0=unlocked, 1=locked */
	/* a <cond, mutex> pair to handle an acquire of a locked lock */
	pthread_cond_t   lock_released;
	pthread_mutex_t  mut;
} pthread_lock;
```







