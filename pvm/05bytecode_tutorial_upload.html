<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.67">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>深入理解 python 虚拟机：字节码教程(2)——控制流是如何实现的？ | Dive into CPython virtual machine</title><meta name="description" content="深入理解 CPython 虚拟机">
    <link rel="preload" href="/dive-into-cpython/assets/style-012314e2.css" as="style"><link rel="stylesheet" href="/dive-into-cpython/assets/style-012314e2.css">
    <link rel="modulepreload" href="/dive-into-cpython/assets/app-6b5e6c63.js"><link rel="modulepreload" href="/dive-into-cpython/assets/05bytecode_tutorial_upload.html-e8da1f64.js"><link rel="modulepreload" href="/dive-into-cpython/assets/qrcode2-187b7271.js"><link rel="modulepreload" href="/dive-into-cpython/assets/05bytecode_tutorial_upload.html-2143825e.js"><link rel="prefetch" href="/dive-into-cpython/assets/index.html-0b09ad74.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/01list.html-69a9c9c1.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/01list_upload.html-fe94b1cc.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/02tuple.html-b7477daf.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/02tuple_upload.html-5a865686.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/03float.html-2f5a3561.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/03float_upload.html-1dfe3d5d.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/04long.html-a472bab8.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/04long_upload.html-2264a99f.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/05complex.html-e8f47248.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/05complex_upload.html-c0f29764.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/06set.html-33c3f396.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/06set_upload.html-ab1e10ed.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/07dict.html-4a49b293.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/07dict_upload.html-a31dc608.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/08bytes.html-b50b2e22.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/08bytes_upload.html-2fe4996a.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/09dict.html-95af47a7.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/09dict_upload.html-48c877d6.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/index.html-8159f4b8.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/01class.html-5fc389a9.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/02application.html-87047342.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/03decriptor.html-1fbadb63.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/04mro.html-555bcac0.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/04mro_upload.html-9e93522d.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/05magicmethod.html-8aba6cdc.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/06magicmethod02.html-c6b3603d.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/07super.html-1579859c.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/index.html-c629a667.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/01pyc.html-c13318e8.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/01pyc_upload.html-8fafa6d0.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/02codeobject.html-279fd19c.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/02codeobject_upload.html-09f56ad5.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/03bytecode.html-7a57a5f9.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/03bytecode_upload.html-8351be8f.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/04bytecode_tutorial.html-489935a7.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/04bytecode_tutorial_upload.html-f57006d2.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/05bytecode_tutorial.html-6a78cdc4.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/06bytecode_tutorial.html-06f0eb45.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/06bytecode_tutorial_upload.html-ef8e0bd6.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/07frameobject.html-6d2788d2.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/07frameobject_upload.html-fe06afcd.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/08debugger.html-c03ffec7.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/09binpyc.html-f16e7564.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/09binpyc_upload.html-a53fadcf.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/index.html-c9043dd6.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/404.html-f9875e7b.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/index.html-5fc350ca.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/01list.html-48896f8b.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/01list_upload.html-a6a982ac.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/02tuple.html-3d8e29b0.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/02tuple_upload.html-d7b68992.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/03float.html-6d2a8832.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/03float_upload.html-5078bd10.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/04long.html-6c0f9b41.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/04long_upload.html-f02f03d0.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/05complex.html-426b2634.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/05complex_upload.html-47fc4032.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/06set.html-16bb4fff.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/06set_upload.html-83bd0f29.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/07dict.html-82c0406d.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/07dict_upload.html-18e84d30.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/08bytes.html-c3122be8.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/08bytes_upload.html-2965b254.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/09dict.html-0af896d9.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/09dict_upload.html-39af21cd.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/index.html-b6a2b5c0.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/01class.html-b3495c25.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/02application.html-0f2fe4c7.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/03decriptor.html-e2b2247d.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/04mro.html-0209b44a.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/04mro_upload.html-a78f4e85.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/05magicmethod.html-6f4baea8.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/06magicmethod02.html-1531fb4c.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/07super.html-70a9aeeb.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/index.html-a299884c.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/01pyc.html-48d80eea.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/01pyc_upload.html-2bdd2fac.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/02codeobject.html-9dc05f47.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/02codeobject_upload.html-01d5e128.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/03bytecode.html-bbda48cf.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/03bytecode_upload.html-c6224de2.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/04bytecode_tutorial.html-9e19855c.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/04bytecode_tutorial_upload.html-6395bf4f.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/05bytecode_tutorial.html-f45ac99c.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/06bytecode_tutorial.html-b63ebf5c.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/06bytecode_tutorial_upload.html-e35769ed.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/07frameobject.html-76657c87.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/07frameobject_upload.html-b3d6d0cb.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/08debugger.html-a6077842.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/09binpyc.html-bf0be7bd.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/09binpyc_upload.html-f0e867f3.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/index.html-27b63451.js" as="script"><link rel="prefetch" href="/dive-into-cpython/assets/404.html-c9a64978.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/dive-into-cpython/" class=""><img class="logo" src="/dive-into-cpython/profile.jpeg" alt="Dive into CPython virtual machine"><span class="site-name can-hide">Dive into CPython virtual machine</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/dive-into-cpython/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/dive-into-cpython/objects/" class="" aria-label="数据结构对象"><!--[--><!--]--> 数据结构对象 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/dive-into-cpython/obsy/" class="" aria-label="对象系统"><!--[--><!--]--> 对象系统 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/dive-into-cpython/pvm/" class="router-link-active" aria-label="PVM"><!--[--><!--]--> PVM <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/Chang-LeHung/dive-into-cpython" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/dive-into-cpython/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/dive-into-cpython/objects/" class="" aria-label="数据结构对象"><!--[--><!--]--> 数据结构对象 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/dive-into-cpython/obsy/" class="" aria-label="对象系统"><!--[--><!--]--> 对象系统 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/dive-into-cpython/pvm/" class="router-link-active" aria-label="PVM"><!--[--><!--]--> PVM <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/Chang-LeHung/dive-into-cpython" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a href="/dive-into-cpython/pvm/01pyc.html" class="sidebar-item sidebar-heading" aria-label="深入理解 python 虚拟机：pyc 文件结构"><!--[--><!--]--> 深入理解 python 虚拟机：pyc 文件结构 <!--[--><!--]--></a><!----></li><li><a href="/dive-into-cpython/pvm/02codeobject.html" class="sidebar-item sidebar-heading" aria-label="深入理解 python 虚拟机：字节码灵魂——Code obejct"><!--[--><!--]--> 深入理解 python 虚拟机：字节码灵魂——Code obejct <!--[--><!--]--></a><!----></li><li><a href="/dive-into-cpython/pvm/03bytecode.html" class="sidebar-item sidebar-heading" aria-label="深入理解 python 虚拟机：令人拍案叫绝的字节码设计"><!--[--><!--]--> 深入理解 python 虚拟机：令人拍案叫绝的字节码设计 <!--[--><!--]--></a><!----></li><li><a href="/dive-into-cpython/pvm/04bytecode_tutorial.html" class="sidebar-item sidebar-heading" aria-label="深入理解 python 虚拟机：字节码教程(1)——原来装饰器是这样实现的"><!--[--><!--]--> 深入理解 python 虚拟机：字节码教程(1)——原来装饰器是这样实现的 <!--[--><!--]--></a><!----></li><li><a href="/dive-into-cpython/pvm/05bytecode_tutorial.html" class="sidebar-item sidebar-heading" aria-label="深入理解 python 虚拟机：字节码教程(2)——控制流是如何实现的？"><!--[--><!--]--> 深入理解 python 虚拟机：字节码教程(2)——控制流是如何实现的？ <!--[--><!--]--></a><!----></li><li><a href="/dive-into-cpython/pvm/06bytecode_tutorial.html" class="sidebar-item sidebar-heading" aria-label="深入理解 python 虚拟机：字节码教程(3)——深入剖析循环实现原理"><!--[--><!--]--> 深入理解 python 虚拟机：字节码教程(3)——深入剖析循环实现原理 <!--[--><!--]--></a><!----></li><li><a href="/dive-into-cpython/pvm/07frameobject.html" class="sidebar-item sidebar-heading" aria-label="深入理解python虚拟机：程序执行的载体——栈帧"><!--[--><!--]--> 深入理解python虚拟机：程序执行的载体——栈帧 <!--[--><!--]--></a><!----></li><li><a href="/dive-into-cpython/pvm/08debugger.html" class="sidebar-item sidebar-heading" aria-label="深入理解python虚拟机：调试器实现原理与源码分析"><!--[--><!--]--> 深入理解python虚拟机：调试器实现原理与源码分析 <!--[--><!--]--></a><!----></li><li><a href="/dive-into-cpython/pvm/09binpyc.html" class="sidebar-item sidebar-heading" aria-label="深入理解 python 虚拟机：破解核心魔法——反序列化 pyc 文件"><!--[--><!--]--> 深入理解 python 虚拟机：破解核心魔法——反序列化 pyc 文件 <!--[--><!--]--></a><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="深入理解-python-虚拟机-字节码教程-2-——控制流是如何实现的" tabindex="-1"><a class="header-anchor" href="#深入理解-python-虚拟机-字节码教程-2-——控制流是如何实现的" aria-hidden="true">#</a> 深入理解 python 虚拟机：字节码教程(2)——控制流是如何实现的？</h1><p>在本篇文章当中主要给大家分析 python 当中与控制流有关的字节码，通过对这部分字节码的了解，我们可以更加深入了解 python 字节码的执行过程和控制流实现原理。</p><h2 id="控制流实现" tabindex="-1"><a class="header-anchor" href="#控制流实现" aria-hidden="true">#</a> 控制流实现</h2><p>控制流这部分代码主要涉及下面几条字节码指令，下面的所有字节码指令都会有一个参数：</p><ul><li><strong>JUMP_FORWARD</strong>，指令完整条指令会将当前执行字节码指令的位置加上这个参数，然后跳到对应的结果继续执行。</li><li><strong>POP_JUMP_IF_TRUE</strong>，如果栈顶元素等于 true，将字节码的执行位置改成参数的值。将栈顶元素弹出。</li><li><strong>POP_JUMP_IF_FALSE</strong>，这条指令和 <strong>POP_JUMP_IF_TRUE</strong> 一样，唯一差别就是判断栈顶元素是否等于 true。</li><li><strong>JUMP_IF_TRUE_OR_POP</strong>，如果栈顶元素等于等于 true 则将字节码执行位置设置成参数对应的值，并且不需要将栈顶元素弹出。但是如果栈顶元素是 false 的话那么就需要将栈顶元素弹出。</li><li><strong>JUMP_IF_FALSE_OR_POP</strong>，和<strong>JUMP_IF_TRUE_OR_POP</strong>一样只不过需要栈顶元素等于 false 。</li><li><strong>JUMP_ABSOLUTE</strong>，直接将字节码的执行位置设置成参数的值。</li></ul><p>总的来说，这些跳转指令可以让 Python 的解释器在执行字节码时根据特定条件来改变执行流程，实现循环、条件语句等基本语言结构。</p><p>现在我们使用一个例子来深入理解上面的各种指令的执行过程。</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>
<span class="token keyword">import</span> dis


<span class="token keyword">def</span> <span class="token function">test_control01</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    a <span class="token operator">=</span> <span class="token number">1</span>

    <span class="token keyword">if</span> a <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;a &gt; 1&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> a <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;a &lt; 1&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;a == 1&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&#39;__main__&#39;</span><span class="token punctuation">:</span>
    dis<span class="token punctuation">.</span>dis<span class="token punctuation">(</span>test_control01<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的程序输出结果如下所示：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>  <span class="token number">6</span>           <span class="token number">0</span> LOAD_CONST               <span class="token number">1</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
              <span class="token number">2</span> STORE_FAST               <span class="token number">0</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span>

  <span class="token number">8</span>           <span class="token number">4</span> LOAD_FAST                <span class="token number">0</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span>
              <span class="token number">6</span> LOAD_CONST               <span class="token number">1</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
              <span class="token number">8</span> COMPARE_OP               <span class="token number">4</span> <span class="token punctuation">(</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>
             <span class="token number">10</span> POP_JUMP_IF_FALSE       <span class="token number">22</span>

  <span class="token number">9</span>          <span class="token number">12</span> LOAD_GLOBAL              <span class="token number">0</span> <span class="token punctuation">(</span>print<span class="token punctuation">)</span>
             <span class="token number">14</span> LOAD_CONST               <span class="token number">2</span> <span class="token punctuation">(</span><span class="token string">&#39;a &gt; 1&#39;</span><span class="token punctuation">)</span>
             <span class="token number">16</span> CALL_FUNCTION            <span class="token number">1</span>
             <span class="token number">18</span> POP_TOP
             <span class="token number">20</span> JUMP_FORWARD            <span class="token number">26</span> <span class="token punctuation">(</span>to <span class="token number">48</span><span class="token punctuation">)</span>

 <span class="token number">10</span>     <span class="token operator">&gt;&gt;</span>   <span class="token number">22</span> LOAD_FAST                <span class="token number">0</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span>
             <span class="token number">24</span> LOAD_CONST               <span class="token number">1</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
             <span class="token number">26</span> COMPARE_OP               <span class="token number">0</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token punctuation">)</span>
             <span class="token number">28</span> POP_JUMP_IF_FALSE       <span class="token number">40</span>

 <span class="token number">11</span>          <span class="token number">30</span> LOAD_GLOBAL              <span class="token number">0</span> <span class="token punctuation">(</span>print<span class="token punctuation">)</span>
             <span class="token number">32</span> LOAD_CONST               <span class="token number">3</span> <span class="token punctuation">(</span><span class="token string">&#39;a &lt; 1&#39;</span><span class="token punctuation">)</span>
             <span class="token number">34</span> CALL_FUNCTION            <span class="token number">1</span>
             <span class="token number">36</span> POP_TOP
             <span class="token number">38</span> JUMP_FORWARD             <span class="token number">8</span> <span class="token punctuation">(</span>to <span class="token number">48</span><span class="token punctuation">)</span>

 <span class="token number">13</span>     <span class="token operator">&gt;&gt;</span>   <span class="token number">40</span> LOAD_GLOBAL              <span class="token number">0</span> <span class="token punctuation">(</span>print<span class="token punctuation">)</span>
             <span class="token number">42</span> LOAD_CONST               <span class="token number">4</span> <span class="token punctuation">(</span><span class="token string">&#39;a == 1&#39;</span><span class="token punctuation">)</span>
             <span class="token number">44</span> CALL_FUNCTION            <span class="token number">1</span>
             <span class="token number">46</span> POP_TOP
        <span class="token operator">&gt;&gt;</span>   <span class="token number">48</span> LOAD_CONST               <span class="token number">0</span> <span class="token punctuation">(</span>None<span class="token punctuation">)</span>
             <span class="token number">50</span> RETURN_VALUE
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们现在来模拟一下上面的字节码执行过程，我们使用 counter 表示当前字节码的执行位置：</p><p>在字节码还没开始执行之前，栈空间和 counter 的状态如下：</p><p><img src="https://img2023.cnblogs.com/blog/2519003/202304/2519003-20230410183232525-1509836492.png" alt=""></p><p>现在执行第一条字节码 LOAD_CONST，执行完之后 counter = 2，因为这条字节码占一个字节，参数栈一个字节，因此下次执行的字节码的位置在 bytecode 的低三个位置，对应的下标为 2，因此 counter = 2 。</p><p><img src="https://img2023.cnblogs.com/blog/2519003/202304/2519003-20230410183232827-626636991.png" alt=""></p><p>现在执行第二条字节码 STORE_FAST，让 a 指向 1 ，同样的 STORE_FAST 操作码和操作数各占一个字节，因此执行完这条字节码之后栈空间没有数据，counter = 4 。</p><p><img src="https://img2023.cnblogs.com/blog/2519003/202304/2519003-20230410183233153-308067382.png" alt=""></p><p>接下来 LOAD_FAST 将 a 指向的对象也就是 1 加载进入栈中，此时的 counter = 6，LOAD_CONST 将常量 1 加载进行入栈空间当中，此时 counter = 8，在执行完这两条指令之后，栈空间的变化如下图所示：</p><p><img src="https://img2023.cnblogs.com/blog/2519003/202304/2519003-20230410183233423-159621690.png" alt=""></p><p>接下来的一条指令是 COMPARE_OP ，这个指令有一个参数表示比较的符号，这里是比较 a &gt; 1，并且会将比较的结果压入栈中，比较的结果是 false ，因为 COMPARE_OP 首先会将栈空间的两个输入弹出，因此在执行完这条指令之后栈空间和 counter 的值如下：</p><p><img src="https://img2023.cnblogs.com/blog/2519003/202304/2519003-20230410183233696-1403260426.png" alt=""></p><p>下面一条指令为 POP_JUMP_IF_FALSE，根据前面的字节码含义，这个字节码会将栈顶的 false 弹出，并且会进行跳转，并且将 counter 的值直接编程参数的值，这里他的参数是 22 ，因此 counter = 22，在执行完这条指令之后，结果如下：</p><p><img src="https://img2023.cnblogs.com/blog/2519003/202304/2519003-20230410183233983-1429924381.png" alt=""></p><p>因为现在已经跳转到了 22 ，因此接下来执行的指令为 LOAD_FAST，将变量 a 加载进入栈空间，LOAD_CONST 将常量 1 加载进入栈空间，在执行完这两条执行之后，变化情况如下：</p><p><img src="https://img2023.cnblogs.com/blog/2519003/202304/2519003-20230410183234285-1813252832.png" alt=""></p><p>在次执行 POP_JUMP_IF_FALSE，这回的结果也是 false ，因此继续执行 POP_JUMP_IF_FALSE，这次的参数是 40，直接将 counter 的值设置成 40 。</p><p><img src="https://img2023.cnblogs.com/blog/2519003/202304/2519003-20230410183234602-1978151706.png" alt=""></p><p>接下来 LOAD_GLOBAL 加载一个全局变量 print 函数 counter 变成 42 ，LOAD_CONST 加载字符串 &quot;a == 1&quot; 进入栈空间，counter = 44，此时状态如下：</p><p><img src="https://img2023.cnblogs.com/blog/2519003/202304/2519003-20230410183234905-866387084.png" alt=""></p><p>CALL_FUNCTION 这个字节码有一个参数，表示调用函数的参数的个数，这里是 1，因为 print 函数只有一个参数，然后输出字符串 &quot;a== 1&quot;，但是这里需要注意的是 print 函数会返回一个 None，因此执行完 CALL_FUNCTION 之后状态如下：</p><p><img src="https://img2023.cnblogs.com/blog/2519003/202304/2519003-20230410183235221-351530226.png" alt=""></p><p>至此差不多上面的函数差不多执行完了，后面几条字节码很简单，就不再进行叙述了。</p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>在 Python 中，控制流指令可以让解释器根据特定条件改变执行流程，实现循环、条件语句等基本语言结构。Python 中与控制流有关的字节码指令包括 JUMP_FORWARD、POP_JUMP_IF_TRUE、POP_JUMP_IF_FALSE、JUMP_IF_TRUE_OR_POP、JUMP_IF_FALSE_OR_POP 和 JUMP_ABSOLUTE 等。这些指令都有一个参数，主要是用来计算跳转的目标位置等。通过对这些指令的了解，我们可以更深入地理解 Python 字节码的执行过程和控制流实现原理。</p><hr><p>本篇文章是深入理解 python 虚拟机系列文章之一，文章地址：https://github.com/Chang-LeHung/dive-into-cpython</p><p>更多精彩内容合集可访问项目：<a href="https://github.com/Chang-LeHung/CSCore" target="_blank" rel="noopener noreferrer">https://github.com/Chang-LeHung/CSCore<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>关注公众号：一无是处的研究僧，了解更多计算机（Java、Python、计算机系统基础、算法与数据结构）知识。</p><p><img src="/dive-into-cpython/assets/qrcode2-8057aa96.jpg" alt=""></p></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: changlehung@qq.com">changlehung</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/dive-into-cpython/assets/app-6b5e6c63.js" defer></script>
  </body>
</html>
